<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Table Editor</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='header.css') }}">
  <style>
    :root {
      --primary-blue: #1e3799;
      --primary-yellow: #ffd32a;
      --secondary-blue: #4a69bd;
      --secondary-yellow: #ffeaa7;
      --neutral-dark: #2d3436;
      --neutral-gray: #636e72;
      --neutral-light: #f5f6fa;
      --toolbar-height: 70px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      color: var(--neutral-dark);
      min-height: 100vh;
      padding-top: 0; /* Reduce top padding for new header */
    }

    header {
      height: 180px;
      position: sticky;
      top: 0;
      left: 0;
      width: 100%;
      background: linear-gradient(to right, var(--primary-blue), var(--secondary-blue));
      color: var(--primary-yellow);
      text-align: center;
      font-size: 2.8rem;
      font-weight: 800;
      padding: 60px;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      letter-spacing: 1px;
      margin-bottom: 20px;
      border-radius: 15px;
    }

    .subtitle {
      font-size: 1.1rem;
      color: var(--secondary-yellow);
      margin-top: 10px;
      font-weight: 400;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Editor Toolbar */
    .editor-toolbar {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      margin-bottom: 30px;
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      align-items: center;
      position: sticky;
      top: 200px;
      z-index: 900;
    }

    .toolbar-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 180px;
    }

    .toolbar-label {
      font-weight: 600;
      color: var(--neutral-dark);
      white-space: nowrap;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toolbar-label i {
      color: var(--primary-blue);
    }

    .toolbar-input {
      padding: 12px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      font-size: 1rem;
      width: 100%;
      transition: all 0.3s ease;
    }

    .toolbar-input:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(30, 55, 153, 0.2);
    }

    .table-section {
      position: relative;
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      margin-bottom: 60px;
    }

    .table-container {
      width: 100%;
      overflow-x: auto;
      border-radius: 10px;
      position: relative;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      table-layout: fixed;
    }

    th, td {
      position: relative;
      border: 1px solid #e2e8f0;
      padding: 15px;
      text-align: left;
      width: 150px;   /* optional default width */
      height: 60px;   /* optional default height */
      min-width: 0;   /* allow shrinking */
      min-height: 0;  /* allow shrinking */
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    th {
      background: linear-gradient(to bottom, var(--secondary-blue), var(--primary-blue));
      color: white;
      font-weight: 600;
      text-align: center;
      font-size: 1.1rem;
    }

    td {
      background-color: white;
      transition: background 0.2s ease;
    }

    td:hover {
      background-color: #f8fafc;
    }

    td:focus {
      outline: 2px solid var(--primary-blue);
      background-color: #fff;
      z-index: 2;
    }

    .selected {
      outline: 3px solid var(--primary-yellow);
      background: var(--secondary-yellow);
    }

    .cell-context {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 6px;
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 1;
    }

    th:hover .cell-context,
    td:hover .cell-context {
      opacity: 1;
    }

    .context-btn {
      width: 28px;
      height: 28px;
      font-size: 14px;
      background: var(--neutral-gray);
      color: white;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .context-btn:hover {
      transform: scale(1.15);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .delete-row { background: #e74c3c; }
    .delete-col { background: #f39c12; }

    footer {
      text-align: center;
      color: var(--neutral-gray);
      font-size: 0.9rem;
      padding: 20px;
      margin-top: 30px;
    }

    /* Add button styles */
    .add-btn {
      position: absolute;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
      color: var(--primary-yellow);
      border: none;
      border-radius: 50%;
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      z-index: 10;
      transition: all 0.3s ease;
    }

    .add-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    }

    #addRowBtn {
      bottom: -25px;
      left: 30px;
    }

    #addColBtn {
      top: -25px;
      right: 30px;
    }

    .btn-label {
      position: absolute;
      background: var(--neutral-dark);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      white-space: nowrap;
    }

    #addRowBtn .btn-label {
      top: -35px;
      left: 50%;
      transform: translateX(-50%);
    }

    #addColBtn .btn-label {
      bottom: -35px;
      right: 50%;
      transform: translateX(50%);
    }

    .add-btn:hover .btn-label {
      opacity: 1;
    }

    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .status-active {
      background-color: #2ecc71;
      color: white;
    }

    .status-leave {
      background-color: #f39c12;
      color: white;
    }

    @media (max-width: 900px) {
      .editor-toolbar {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
      }

      .toolbar-section {
        min-width: 100%;
      }
    }

    @media (max-width: 768px) {
      header {
        font-size: 2rem;
        padding: 40px 20px;
        height: auto;
      }

      .add-btn {
        width: 40px;
        height: 40px;
        font-size: 1.5rem;
      }

      #addRowBtn {
        bottom: -20px;
        left: 20px;
      }

      #addColBtn {
        top: -20px;
        right: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="header-container">
    <div class="header-main">
      <div class="auth-buttons">
        <a href="#" class="auth-button login">Log In</a>
        <a href="#" class="auth-button register">Register</a>
      </div>
      <a href="/" class="site-title">Tafeltennis club De Pinte</a>
    </div>
    <nav>
      <div class="nav-links">
        <a href="{{ url_for('home') }}">Home</a>
        <a href="{{ url_for('info') }}">Info</a>
        <a href="{{ url_for('home') }}#competition">Competition</a>
        <a href="{{ url_for('activities') }}">News</a>
        <a href="{{ url_for('home') }}#contact">Contact</a>
        <a href="{{ url_for('training') }}">Training</a>
      </div>
    </nav>
  </div>

  <div class="container">
    <!-- Editor Toolbar -->
    <div class="editor-toolbar">
      <div class="toolbar-section">
        <span class="toolbar-label"><i class="fas fa-fill-drip"></i> Background Color</span>
        <input type="color" id="cellColor" class="toolbar-input" value="#4a69bd">
      </div>

      <div class="toolbar-section">
        <span class="toolbar-label"><i class="fas fa-font"></i> Text Color</span>
        <input type="color" id="textColor" class="toolbar-input" value="#ffffff">
      </div>

      <div class="toolbar-section">
        <span class="toolbar-label"><i class="fas fa-arrows-alt-v"></i> Row Height (px)</span>
        <input type="number" id="rowHeight" class="toolbar-input" min="30" max="200" value="60">
      </div>

      <div class="toolbar-section">
        <span class="toolbar-label"><i class="fas fa-arrows-alt-h"></i> Column Width (px)</span>
        <input type="number" id="colWidth" class="toolbar-input" min="50" max="300" value="150">
      </div>
    </div>

    <div class="table-section">
      <button class="add-btn" id="addColBtn">
        +
        <span class="btn-label">Add Column</span>
      </button>

      <div class="table-container">
        <table id="editableTable">
          <thead>
            <tr>
              <th>Employee</th>
              <th>Department</th>
              <th>Position</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td contenteditable="true">Alex Johnson <div class="cell-context"><button class="context-btn delete-row" title="Delete Row">ðŸ—‘</button><button class="context-btn delete-col" title="Delete Column">â–¤</button></div></td>
              <td contenteditable="true">Marketing <div class="cell-context"><button class="context-btn delete-row" title="Delete Row">ðŸ—‘</button><button class="context-btn delete-col" title="Delete Column">â–¤</button></div></td>
              <td contenteditable="true">Manager <div class="cell-context"><button class="context-btn delete-row" title="Delete Row">ðŸ—‘</button><button class="context-btn delete-col" title="Delete Column">â–¤</button></div></td>
              <td contenteditable="true">5 years<div class="cell-context"><button class="context-btn delete-row" title="Delete Row">ðŸ—‘</button><button class="context-btn delete-col" title="Delete Column">â–¤</button></div></td>
            </tr>
            <tr>
              <td contenteditable="true">Maria Garcia <div class="cell-context"><button class="context-btn delete-row" title="Delete Row">ðŸ—‘</button><button class="context-btn delete-col" title="Delete Column">â–¤</button></div></td>
              <td contenteditable="true">Engineering <div class="cell-context"><button class="context-btn delete-row" title="Delete Row">ðŸ—‘</button><button class="context-btn delete-col" title="Delete Column">â–¤</button></div></td>
              <td contenteditable="true">Developer <div class="cell-context"><button class="context-btn delete-row" title="Delete Row">ðŸ—‘</button><button class="context-btn delete-col" title="Delete Column">â–¤</button></div></td>
              <td contenteditable="true">3 years<div class="cell-context"><button class="context-btn delete-row" title="Delete Row">ðŸ—‘</button><button class="context-btn delete-col" title="Delete Column">â–¤</button></div></td>
            </tr>
            <tr>
              <td contenteditable="true">Robert Smith <div class="cell-context"><button class="context-btn delete-row" title="Delete Row">ðŸ—‘</button><button class="context-btn delete-col" title="Delete Column">â–¤</button></div></td>
              <td contenteditable="true">Sales <div class="cell-context"><button class="context-btn delete-row" title="Delete Row">ðŸ—‘</button><button class="context-btn delete-col" title="Delete Column">â–¤</button></div></td>
              <td contenteditable="true">Representative <div class="cell-context"><button class="context-btn delete-row" title="Delete Row">ðŸ—‘</button><button class="context-btn delete-col" title="Delete Column">â–¤</button></div></td>
              <td contenteditable="true">2 years<div class="cell-context"><button class="context-btn delete-row" title="Delete Row">ðŸ—‘</button><button class="context-btn delete-col" title="Delete Column">â–¤</button></div></td>
            </tr>
            <tr>
              <td contenteditable="true">Sarah Williams <div class="cell-context"><button class="context-btn delete-row" title="Delete Row">ðŸ—‘</button><button class="context-btn delete-col" title="Delete Column">â–¤</button></div></td>
              <td contenteditable="true">HR <div class="cell-context"><button class="context-btn delete-row" title="Delete Row">ðŸ—‘</button><button class="context-btn delete-col" title="Delete Column">â–¤</button></div></td>
              <td contenteditable="true">Recruiter <div class="cell-context"><button class="context-btn delete-row" title="Delete Row">ðŸ—‘</button><button class="context-btn delete-col" title="Delete Column">â–¤</button></div></td>
              <td contenteditable="true">4 years<div class="cell-context"><button class="context-btn delete-row" title="Delete Row">ðŸ—‘</button><button class="context-btn delete-col" title="Delete Column">â–¤</button></div></td>
            </tr>
          </tbody>
        </table>
      </div>

      <button class="add-btn" id="addRowBtn">
        +
        <span class="btn-label">Add Row</span>
      </button>
    </div>
  </div>

  <footer>
    <p>Advanced Table Editor &copy; 2025 | Real-Time Styling</p>
  </footer>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const table = document.getElementById('editableTable');
      const tbody = table.querySelector('tbody');
      const thead = table.querySelector('thead');
      const cellColor = document.getElementById('cellColor');
      const textColor = document.getElementById('textColor');
      const rowHeight = document.getElementById('rowHeight');
      const colWidth = document.getElementById('colWidth');
      const addRowBtn = document.getElementById('addRowBtn');
      const addColBtn = document.getElementById('addColBtn');

      // Hide the header row visually but keep it in DOM
      thead.style.display = 'none';

      // Create combine/separate buttons
      const combineBtn = document.createElement('button');
      combineBtn.id = 'combineBtn';
      combineBtn.textContent = 'Combine Cells';
      combineBtn.style.cssText = `
        padding: 12px 20px;
        background: linear-gradient(to right, var(--primary-blue), var(--secondary-blue));
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
      `;

      const separateBtn = document.createElement('button');
      separateBtn.id = 'separateBtn';
      separateBtn.textContent = 'Separate Cell';
      separateBtn.style.cssText = combineBtn.style.cssText;
      separateBtn.style.background = 'linear-gradient(to right, #27ae60, #2ecc71)';

      // Add buttons to toolbar
      const toolbar = document.querySelector('.editor-toolbar');
      const btnContainer = document.createElement('div');
      btnContainer.className = 'toolbar-section';
      btnContainer.style.flexDirection = 'row';
      btnContainer.style.gap = '10px';
      btnContainer.style.minWidth = '100%';
      btnContainer.appendChild(combineBtn);
      btnContainer.appendChild(separateBtn);
      toolbar.appendChild(btnContainer);

      function initializeCell(cell) {
        cell.contentEditable = true;

        // Add context buttons
        const contextDiv = document.createElement('div');
        contextDiv.className = 'cell-context';

        const deleteRowBtn = document.createElement('button');
        deleteRowBtn.className = 'context-btn delete-row';
        deleteRowBtn.title = 'Delete Row';
        deleteRowBtn.innerHTML = 'ðŸ—‘';

        const deleteColBtn = document.createElement('button');
        deleteColBtn.className = 'context-btn delete-col';
        deleteColBtn.title = 'Delete Column';
        deleteColBtn.innerHTML = 'â–¤';

        contextDiv.appendChild(deleteRowBtn);
        contextDiv.appendChild(deleteColBtn);
        cell.appendChild(contextDiv);
      }

      // Combine selected cells
      combineBtn.addEventListener('click', function() {
        if (selectedCells.length < 2) {
          showToast('Select at least 2 cells to combine');
          return;
        }

        if (!isRectangularSelection(selectedCells)) {
          showToast('Selected cells must form a rectangle');
          return;
        }

        const minRow = Math.min(...selectedCells.map(c => c.parentElement.rowIndex));
        const maxRow = Math.max(...selectedCells.map(c => c.parentElement.rowIndex));
        const minCol = Math.min(...selectedCells.map(c => c.cellIndex));
        const maxCol = Math.max(...selectedCells.map(c => c.cellIndex));

        const topLeftCell = selectedCells.find(c =>
          c.parentElement.rowIndex === minRow && c.cellIndex === minCol
        );

        const rowspan = maxRow - minRow + 1;
        const colspan = maxCol - minCol + 1;

        topLeftCell.rowSpan = rowspan;
        topLeftCell.colSpan = colspan;
        topLeftCell.dataset.originalContent = topLeftCell.innerHTML;
        topLeftCell.innerHTML = '<div class="combined-content">Combined Cell</div>';

        // Save combined cell styles
        topLeftCell.style.backgroundColor = cellColor.value;
        topLeftCell.style.color = textColor.value;

        selectedCells.forEach(cell => {
          if (cell !== topLeftCell) {
            cell.remove();
          }
        });

        selectedCells = [];
        document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
        showToast('Cells combined successfully!');
        saveTable();
      });

      // ENHANCEMENT: Save background and text colors
      function getTableData() {
        const headers = [];
        const headerRow = thead.rows[0];
        for (const th of headerRow.cells) {
            headers.push({
                content: cleanCellContent(th),
                rowspan: th.rowSpan,
                colspan: th.colSpan,
                backgroundColor: th.style.backgroundColor || '',
                color: th.style.color || ''
            });
        }

        const rows = [];
        for (const tr of tbody.rows) {
            const row = [];
            for (const td of tr.cells) {
                row.push({
                    content: cleanCellContent(td),
                    rowspan: td.rowSpan,
                    colspan: td.colSpan,
                    backgroundColor: td.style.backgroundColor || '',
                    color: td.style.color || ''
                });
            }
            rows.push(row);
        }

        return { headers, rows };
      }

      function cleanCellContent(cell) {
        const div = document.createElement('div');
        div.innerHTML = cell.innerHTML;
        const contextDiv = div.querySelector('.cell-context');
        if (contextDiv) contextDiv.remove();
        return div.innerHTML;
      }

      // ENHANCEMENT: Load background and text colors
      function setTableData(data) {
        // Rebuild headers
        thead.innerHTML = '';
        const headerRow = document.createElement('tr');
        data.headers.forEach(header => {
            const th = document.createElement('th');
            th.contentEditable = true;
            th.rowSpan = header.rowspan || 1;
            th.colSpan = header.colspan || 1;
            th.innerHTML = header.content;

            // Apply saved styles
            if (header.backgroundColor) th.style.backgroundColor = header.backgroundColor;
            if (header.color) th.style.color = header.color;

            // Add context buttons
            const contextDiv = document.createElement('div');
            contextDiv.className = 'cell-context';
            contextDiv.innerHTML = `<button class="context-btn delete-row" title="Delete Row">ðŸ—‘</button>
                                   <button class="context-btn delete-col" title="Delete Column">â–¤</button>`;
            th.appendChild(contextDiv);

            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        // Hide header after rebuilding
        thead.style.display = 'none';

        // Rebuild rows
        tbody.innerHTML = '';
        data.rows.forEach(rowData => {
            const row = document.createElement('tr');
            rowData.forEach(cellData => {
                const td = document.createElement('td');
                td.contentEditable = true;
                td.rowSpan = cellData.rowspan || 1;
                td.colSpan = cellData.colspan || 1;
                td.innerHTML = cellData.content;

                // Apply saved styles
                if (cellData.backgroundColor) td.style.backgroundColor = cellData.backgroundColor;
                if (cellData.color) td.style.color = cellData.color;

                // Add context buttons
                const contextDiv = document.createElement('div');
                contextDiv.className = 'cell-context';
                contextDiv.innerHTML = `<button class="context-btn delete-row" title="Delete Row">ðŸ—‘</button>
                                       <button class="context-btn delete-col" title="Delete Column">â–¤</button>`;
                td.appendChild(contextDiv);

                row.appendChild(td);
            });
            tbody.appendChild(row);
        });

        setupContextButtons();
      }

      let saveTimeout;
      function scheduleSave() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveTable, 2000);
      }

      function saveTable() {
        const tableData = getTableData();

        fetch('/api/training-table', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(tableData)
        })
        .then(response => {
          if (!response.ok) throw new Error('Save failed');
          return response.json();
        })
        .then(data => {
          console.log('Table saved:', data);
        })
        .catch(error => {
          console.error('Error saving table:', error);
          setTimeout(saveTable, 1000);
        });
      }

      function setupContextButtons() {
        document.querySelectorAll('.delete-row').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const row = this.closest('tr');
            removeRow(row);
            saveTable();
          });
        });

        document.querySelectorAll('.delete-col').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const cell = this.closest('td, th');
            const colIndex = cell.cellIndex;
            removeColumn(colIndex);
            saveTable();
          });
        });
      }

      table.addEventListener('input', function(e) {
        if (e.target.closest('td, th')) {
          saveTable();
        }
      });

      cellColor.addEventListener('input', function() {
        updateSelectedCells();
        saveTable();
      });

      textColor.addEventListener('input', function() {
        updateSelectedCells();
        saveTable();
      });

      rowHeight.addEventListener('input', function() {
        updateSelectedCells();
        saveTable();
      });

      colWidth.addEventListener('input', function() {
        updateSelectedCells();
        saveTable();
      });

      table.addEventListener('input', scheduleSave);
      addRowBtn.addEventListener('click', scheduleSave);
      addColBtn.addEventListener('click', scheduleSave);
      combineBtn.addEventListener('click', scheduleSave);
      separateBtn.addEventListener('click', scheduleSave);

      // Load saved data on page load
      fetch('/api/training-table')
        .then(response => response.json())
        .then(data => setTableData(data))
        .catch(error => console.error('Error loading table:', error));

      function isRectangularSelection(cells) {
        if (cells.length === 0) return false;

        const minRow = Math.min(...cells.map(c => c.parentElement.rowIndex));
        const maxRow = Math.max(...cells.map(c => c.parentElement.rowIndex));
        const minCol = Math.min(...cells.map(c => c.cellIndex));
        const maxCol = Math.max(...cells.map(c => c.cellIndex));

        const selectedSet = new Set(cells.map(c =>
          `${c.parentElement.rowIndex},${c.cellIndex}`
        ));

        for (let row = minRow; row <= maxRow; row++) {
          for (let col = minCol; col <= maxCol; col++) {
            const key = `${row},${col}`;
            if (!selectedSet.has(key)) {
              return false;
            }
          }
        }

        return true;
      }

      separateBtn.addEventListener('click', function() {
        if (selectedCells.length !== 1) {
          showToast('Select exactly one cell to separate');
          return;
        }

        const cell = selectedCells[0];
        const row = cell.closest('tr');
        const rowIndex = row.rowIndex;
        const colIndex = cell.cellIndex;
        const rowspan = cell.rowSpan || 1;
        const colspan = cell.colSpan || 1;

        if (rowspan === 1 && colspan === 1) {
          showToast('This cell is not combined. Nothing to separate.');
          return;
        }

        // Save styles for restoration
        const bgColor = cell.style.backgroundColor;
        const textColor = cell.style.color;

        cell.rowSpan = 1;
        cell.colSpan = 1;

        if (cell.dataset.originalContent) {
          cell.innerHTML = cell.dataset.originalContent;
          delete cell.dataset.originalContent;
        }

        // Restore styles
        cell.style.backgroundColor = bgColor;
        cell.style.color = textColor;

        for (let r = 0; r < rowspan; r++) {
          let currentRow = table.rows[rowIndex + r];

          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue;

            if (r === 0) {
              const newCell = document.createElement('td');
              currentRow.insertBefore(newCell, currentRow.cells[colIndex + c]);
              initializeCell(newCell);
            } else {
              if (c === 0) {
                const newRow = document.createElement('tr');
                table.tBodies[0].insertBefore(newRow, table.rows[rowIndex + r]);
                currentRow = newRow;
              }
              const newCell = document.createElement('td');
              currentRow.appendChild(newCell);
              initializeCell(newCell);
            }
          }
        }

        setupContextButtons();
        selectedCells = [];
        document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
        showToast('Cell separated successfully!');
        saveTable();
      });

      let selectedCells = [];
      let selectedRow = null;
      let selectedColumn = null;

      table.addEventListener('click', function(e) {
        const cell = e.target.closest('td');

        if (cell && !e.target.closest('.context-btn')) {
          if (e.ctrlKey || e.metaKey) {
            cell.classList.toggle('selected');
            if (cell.classList.contains('selected')) {
              selectedCells.push(cell);
            } else {
              selectedCells = selectedCells.filter(c => c !== cell);
            }
          }
          else {
            document.querySelectorAll('.selected').forEach(c => {
              c.classList.remove('selected');
            });

            selectedCells = [cell];
            cell.classList.add('selected');
            cell.focus();
          }

          if (cell.tagName === 'TD') {
            selectedRow = cell.parentElement;
            selectedColumn = cell.cellIndex;
          }

          if (selectedCells.length === 1) {
            const cell = selectedCells[0];
            cellColor.value = rgbToHex(cell.style.backgroundColor);
            textColor.value = rgbToHex(cell.style.color);

            const rowIndex = cell.parentElement.rowIndex;
            const firstCell = table.rows[rowIndex].cells[0];
            rowHeight.value = parseInt(firstCell.style.height) || 60;

            const colIndex = cell.cellIndex;
            const headerCell = table.rows[0].cells[colIndex];
            colWidth.value = parseInt(headerCell.style.width) || 150;
          }
        }
      });

      function rgbToHex(rgb) {
        if (!rgb) return '#ffffff';
        const match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
        if (!match) return '#ffffff';

        const r = parseInt(match[1]);
        const g = parseInt(match[2]);
        const b = parseInt(match[3]);

        return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
      }

      function updateSelectedCells() {
        if (selectedCells.length === 0) return;

        const rowsToUpdate = new Set();
        selectedCells.forEach(cell => {
          rowsToUpdate.add(cell.parentElement.rowIndex);
        });

        rowsToUpdate.forEach(rowIndex => {
          updateRowHeight(rowIndex, rowHeight.value);
        });

        const columnsToUpdate = new Set();
        selectedCells.forEach(cell => {
          columnsToUpdate.add(cell.cellIndex);
        });

        columnsToUpdate.forEach(colIndex => {
          updateColumnWidth(colIndex, colWidth.value);
        });

        selectedCells.forEach(cell => {
          cell.style.backgroundColor = cellColor.value;
          cell.style.color = textColor.value;
        });
      }

      function updateColumnWidth(colIndex, width) {
        const rows = table.rows;
        for (let i = 0; i < rows.length; i++) {
          const cell = rows[i].cells[colIndex];
          if (cell) {
            cell.style.width = width + 'px';
          }
        }
      }

      function updateRowHeight(rowIndex, height) {
        const row = table.rows[rowIndex];
        if (row) {
          const padding = Math.min(8, Math.max(2, Math.floor(height / 10)));

          for (let i = 0; i < row.cells.length; i++) {
            const cell = row.cells[i];
            cell.style.height = height + 'px';
            cell.style.padding = `${padding}px 15px`;
            const contextBtn = cell.querySelector('.cell-context');
            if (contextBtn) {
              const btnSize = Math.min(20, Math.max(14, Math.floor(height / 3)));
              contextBtn.style.gap = '3px';
              contextBtn.querySelectorAll('.context-btn').forEach(btn => {
                btn.style.width = `${btnSize}px`;
                btn.style.height = `${btnSize}px`;
                btn.style.fontSize = `${Math.max(10, btnSize - 6)}px`;
              });
            }
          }
        }
      }

      cellColor.addEventListener('input', updateSelectedCells);
      textColor.addEventListener('input', updateSelectedCells);
      rowHeight.addEventListener('input', updateSelectedCells);
      colWidth.addEventListener('input', updateSelectedCells);

      function removeRow(row) {
        if (tbody.rows.length > 1) {
          row.remove();
          selectedRow = null;
          showToast('Row removed successfully!');
        } else {
          alert('You need at least one row!');
        }
      }

      function removeColumn(colIndex) {
        const rows = table.rows;

        if (rows[0].cells.length > 1) {
          for (let i = 0; i < rows.length; i++) {
            if (rows[i].cells[colIndex]) {
              rows[i].deleteCell(colIndex);
            }
          }
          selectedColumn = null;
          showToast('Column removed successfully!');
        } else {
          alert('You need at least one column!');
        }
      }

      setupContextButtons();
      addRowBtn.addEventListener('click', addRow);
      addColBtn.addEventListener('click', addColumn);

      function showToast(message) {
        const existingToast = document.getElementById('custom-toast');
        if (existingToast) existingToast.remove();

        const toast = document.createElement('div');
        toast.id = 'custom-toast';
        toast.textContent = message;
        toast.style.cssText = `
          position: fixed;
          bottom: 30px;
          left: 50%;
          transform: translateX(-50%);
          background: var(--primary-blue);
          color: white;
          padding: 15px 30px;
          border-radius: 30px;
          box-shadow: 0 5px 15px rgba(0,0,0,0.2);
          z-index: 10000;
          opacity: 0;
          transition: opacity 0.3s ease;
          font-weight: 600;
        `;

        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.opacity = '1';
        }, 10);

        setTimeout(() => {
          toast.style.opacity = '0';
          setTimeout(() => {
            toast.remove();
          }, 300);
        }, 3000);
      }

      function addRow() {
        const headerRow = thead.rows[0];
        const colCount = headerRow.cells.length;

        const newRow = tbody.insertRow();

        for (let i = 0; i < colCount; i++) {
          const cell = newRow.insertCell();
          cell.contentEditable = true;
          cell.textContent = `New Row ${tbody.rows.length}, Col ${i + 1}`;
          cell.style.height = rowHeight.value + 'px';

          if (headerRow.cells[i]) {
            cell.style.width = headerRow.cells[i].style.width || colWidth.value + 'px';
          }

          // Apply selected colors to new cells
          cell.style.backgroundColor = cellColor.value;
          cell.style.color = textColor.value;

          const contextDiv = document.createElement('div');
          contextDiv.className = 'cell-context';

          const deleteRowBtn = document.createElement('button');
          deleteRowBtn.className = 'context-btn delete-row';
          deleteRowBtn.title = 'Delete Row';
          deleteRowBtn.innerHTML = 'ðŸ—‘';

          const deleteColBtn = document.createElement('button');
          deleteColBtn.className = 'context-btn delete-col';
          deleteColBtn.title = 'Delete Column';
          deleteColBtn.innerHTML = 'â–¤';

          contextDiv.appendChild(deleteRowBtn);
          contextDiv.appendChild(deleteColBtn);
          cell.appendChild(contextDiv);
        }

        setupContextButtons();
        showToast('New row added successfully!');
        saveTable();
      }

      function addColumn() {
        const rows = table.rows;
        let colIndex = rows[0].cells.length;

        if (selectedCells.length > 0) {
          const selectedCell = selectedCells[0];
          colIndex = selectedCell.cellIndex + 1;
        }

        const widthValue = colWidth.value + 'px';

        const newHeader = document.createElement('th');
        newHeader.textContent = `Column ${colIndex + 1}`;
        newHeader.style.width = widthValue;

        // Apply selected colors to new header
        newHeader.style.backgroundColor = cellColor.value;
        newHeader.style.color = textColor.value;

        const headerContext = document.createElement('div');
        headerContext.className = 'cell-context';
        headerContext.innerHTML = `<button class="context-btn delete-row" title="Delete Row">ðŸ—‘</button>
                                  <button class="context-btn delete-col" title="Delete Column">â–¤</button>`;
        newHeader.appendChild(headerContext);

        if (colIndex >= thead.rows[0].cells.length) {
          thead.rows[0].appendChild(newHeader);
        } else {
          thead.rows[0].insertBefore(newHeader, thead.rows[0].cells[colIndex]);
        }

        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          const newCell = row.insertCell(colIndex);
          newCell.contentEditable = true;
          newCell.textContent = `Row ${i}, New Col`;
          newCell.style.width = widthValue;

          // Apply selected colors to new cells
          newCell.style.backgroundColor = cellColor.value;
          newCell.style.color = textColor.value;

          if (row.cells.length > 0) {
            const firstCell = row.cells[0];
            newCell.style.height = firstCell.style.height || rowHeight.value + 'px';
          } else {
            newCell.style.height = rowHeight.value + 'px';
          }

          const cellContext = document.createElement('div');
          cellContext.className = 'cell-context';

          const cellDeleteRowBtn = document.createElement('button');
          cellDeleteRowBtn.className = 'context-btn delete-row';
          cellDeleteRowBtn.title = 'Delete Row';
          cellDeleteRowBtn.innerHTML = 'ðŸ—‘';

          const cellDeleteColBtn = document.createElement('button');
          cellDeleteColBtn.className = 'context-btn delete-col';
          cellDeleteColBtn.title = 'Delete Column';
          cellDeleteColBtn.innerHTML = 'â–¤';

          cellContext.appendChild(cellDeleteRowBtn);
          cellContext.appendChild(cellDeleteColBtn);
          newCell.appendChild(cellContext);
        }

        setupContextButtons();
        showToast('New column added successfully!');
        saveTable();
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      function addClickListener(selector, callback) {
        const buttons = document.querySelectorAll(selector);
        buttons.forEach(button => {
          button.addEventListener('click', callback);
        });
      }

      addClickListener('.auth-button.login', () => {
        window.location.href = '/login';
      });

      addClickListener('.auth-button.register', () => {
        window.location.href = '/register';
      });

      const homeButton = document.querySelector('.nav-links a[href="#home"]');
      if (homeButton) {
        homeButton.addEventListener('click', (event) => {
          event.preventDefault();
          window.location.href = '/';
        });
      }

      const sections = ['contact', 'info', 'training', 'competition', 'news'];
      sections.forEach(section => {
        const button = document.querySelector(`.nav-links a[href="#${section}"]`);
        if (button) {
          button.addEventListener('click', (event) => {
            event.preventDefault();
            handleNavigation(`#${section}`);
          });
        }
      });
    });

    function handleNavigation(hash) {
      const isHomePage = window.location.pathname === '/' || window.location.pathname.endsWith('home.html');
      if (isHomePage) {
        const sectionId = hash.replace('#', '');
        const section = document.getElementById(sectionId);
        if (section) {
          const headerHeight = document.querySelector('.header-container')?.offsetHeight || 0;
          const targetTop = section.getBoundingClientRect().top + window.pageYOffset - headerHeight;
          window.scrollTo({ top: targetTop, behavior: 'smooth' });
        }
      } else {
        window.location.href = `/${hash}`;
      }
    }
  </script>
</body>
</html>